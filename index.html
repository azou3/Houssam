<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ŸÖÿ™ÿ¨ÿ± ÿßŸÑÿ£ÿµÿØŸÇÿßÿ° - ŸÖÿ®ÿßÿ¥ÿ±</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        :root {
            --primary-color: #ffc107; --secondary-color: #c82333; --dark-color: #212529; --light-color: #f8f9fa;
            --success-color: #28a745; --grey-color: #495057; --font-family: 'Tajawal', sans-serif;
            --info-color: #007bff;
        }
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { overflow-x: hidden; }
        body {
            font-family: var(--font-family); background-color: var(--dark-color); color: var(--light-color);
            background: linear-gradient(rgba(0, 0, 0, 0.88), rgba(0, 0, 0, 0.88)), url('https://images.unsplash.com/photo-1513104890138-7c749659a591?q=80&w=2070&auto=format&fit=crop') center center/cover no-repeat fixed;
        }
        .container { max-width: 1200px; margin: auto; padding: 0 15px; }
        .hidden { display: none !important; }
        .header-top { display: flex; justify-content: space-between; align-items: center; background-color: rgba(0,0,0,0.2); padding: 10px; }
        .time-date-container { text-align: center; color: #ccc; font-size: 1rem; }
        #clock, #date { display: inline-block; margin: 0 5px; }
        #profile-btn { background: none; border: none; cursor: pointer; position: relative; }
        #profile-btn svg { width: 30px; height: 30px; color: var(--primary-color); }
        .marquee { background-color: var(--secondary-color); color: white; padding: 10px; overflow: hidden; white-space: nowrap; }
        .marquee-content { display: inline-block; padding-right: 100%; animation: marquee 60s linear infinite; }
        .marquee-content span { margin: 0 30px; font-size: 1.1rem; }
        @keyframes marquee { 0% { transform: translateX(0%); } 100% { transform: translateX(100%); } }
        .prayer-marquee { background-color: var(--info-color); }
        #map { height: 280px; border-radius: 10px; border: 2px solid var(--primary-color); margin-top:10px; z-index: 1; }
        .leaflet-control-layers { border-radius: 5px; opacity: 0.8; }
        .pinpoint-btn { width: 100%; padding: 12px; margin-top: 10px; font-size: 1rem; background-color: var(--info-color); color: white; border: none; border-radius: 8px; cursor: pointer; }
        #loader { position: fixed; top:0; left: 0; width: 100%; height: 100%; background: var(--dark-color); display: flex; justify-content: center; align-items: center; text-align: center; padding: 1rem; font-size: 1.5rem; color: var(--primary-color); z-index: 9999; }
        header { text-align: center; padding: 20px 15px; }
        header h1 { font-size: 2.2rem; color: var(--primary-color); text-shadow: 2px 2px 4px rgba(0,0,0,0.7); }
        .search-bar { margin: 15px auto; max-width: 600px; }
        .search-bar input { width: 100%; padding: 12px; background-color: rgba(255,255,255,0.1); border: 1px solid var(--primary-color); border-radius: 8px; color: white; font-size: 1rem; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 15px; }
        .product-card { background-color: var(--dark-color); border: 1px solid var(--grey-color); border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: flex; flex-direction: column; position: relative; }
        .product-card.unavailable { opacity: 0.6; }
        .product-card.unavailable::after { content: 'ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±'; position: absolute; top: 40%; left: 50%; transform: translateX(-50%) translateY(-50%) rotate(-15deg); background-color: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 5px; font-weight: bold; }
        .product-image-container { position: relative; cursor: pointer; }
        .product-image { width: 100%; height: 180px; object-fit: cover; background-color: var(--grey-color); }
        .special-offer-tag { position: absolute; top: 10px; left: 10px; background-color: var(--secondary-color); color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; }
        .product-info { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; text-align: center; }
        .product-info h3 { font-size: 1.3rem; color: var(--primary-color); margin-bottom: 10px; }
        .add-to-cart-btn { background-color: var(--primary-color); color: var(--dark-color); border: none; padding: 12px; font-size: 1rem; font-weight: bold; border-radius: 8px; cursor: pointer; margin-top: auto; }
        h2.section-title { text-align: center; font-size: 2rem; color: var(--primary-color); margin-bottom: 20px; }
        h2.section-title::after { content: ''; display: block; width: 60px; height: 3px; background: var(--secondary-color); margin: 8px auto 0; border-radius: 2px; }
        .cart-section { background-color: rgba(0,0,0,0.75); padding: 20px; margin-top: 40px; border-radius: 15px; border-top: 4px solid var(--primary-color); }
        .contact-buttons { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--grey-color); display: flex; flex-direction: column; gap: 10px; }
        .form-group { margin-top: 15px; }
        .form-group input, .form-group select { padding: 10px; border-radius: 5px; border: 1px solid #555; background-color: #333; color: white; font-size: 1rem; width: 100%; }
        .admin-panel { background-color: #1c1c1c; padding: 15px; margin-top: 20px; border-radius: 10px; border: 1px solid var(--primary-color); }
        .admin-stats { display: flex; flex-wrap: wrap; justify-content: space-around; background-color: var(--dark-color); padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; gap: 10px; }
        .stat-item h4 { color: var(--primary-color); font-size: 0.8rem; } .stat-item p { font-size: 1.4rem; font-weight: bold; }
        .admin-product-controls { display: grid; grid-template-columns: 1fr; gap: 10px; align-items: center; padding: 10px; border-bottom: 1px solid var(--grey-color); }
        .admin-controls-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .admin-controls-buttons button, .admin-controls-buttons label { padding: 8px; cursor: pointer; border-radius: 5px; border: none; font-size: 0.8rem; text-align: center; }
        .delete-btn { background-color: var(--secondary-color); color: white; }
        .toggle-status-btn-available { background-color: var(--success-color); color: white; }
        .toggle-status-btn-unavailable { background-color: var(--grey-color); color: white; }
        .duplicate-btn { background-color: #007bff; color: white; }
        .toggle-offer-btn { background-color: #fd7e14; color: white; }
        .edit-image-label { background-color: #17a2b8; color: white; display: inline-block; }
        .admin-controls-buttons input[type="file"] { display: none; }
        #image-modal, .auth-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        #image-modal img { max-width: 90%; max-height: 80%; border-radius: 10px; border: 3px solid var(--primary-color); }
        #image-modal-close { position: absolute; top: 20px; right: 30px; color: white; font-size: 2.5rem; cursor: pointer; }
        .contact-btn { display: flex; justify-content: center; align-items: center; gap: 8px; padding: 12px; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; color: white; text-decoration: none; cursor: pointer; transition: background-color 0.3s, opacity 0.3s; }
        .contact-btn:hover { opacity: 0.9; }
        .whatsapp-btn { background-color: #25D366; }
        .messenger-btn { background-color: #00B2FF; }
        .pinpoint-btn { background-color: var(--info-color); }
        .modal-content { background-color: var(--dark-color); padding: 20px; border-radius: 10px; border: 1px solid var(--primary-color); width: 90%; max-width: 400px; }
        .close-modal-btn { float: left; font-size: 2rem; font-weight: bold; cursor: pointer; color: #aaa; }
        .modal-content h3 { text-align: center; color: var(--primary-color); margin-bottom: 20px; }
        .modal-content button { width: 100%; padding: 12px; background-color: var(--primary-color); color: var(--dark-color); border: none; border-radius: 5px; font-weight: bold; }
    </style>
</head>
<body>
    <div id="loader" class="container">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÖÿ™ÿ¨ÿ±...</div>

    <div id="app-content" class="hidden">
         <div class="header-top">
            <button id="profile-btn" aria-label="Profile">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.982 18.725A7.488 7.488 0 0012 15.75a7.488 7.488 0 00-5.982 2.975m11.963 0a9 9 0 10-11.963 0m11.963 0L12 21m-8.982-2.275A9 9 0 0112 3v1.75m0 10.5a7.456 7.456 0 01-5.982 2.975c-1.33-1.01-2.073-2.585-2.073-4.225a9 9 0 0118 0c0 1.64-.743 3.215-2.073 4.225A7.456 7.456 0 0112 15.75v-1.75a7.456 7.456 0 015.982-2.975c1.33 1.01 2.073 2.585 2.073 4.225a9 9 0 01-18 0c0-1.64.743-3.215 2.073-4.225A7.456 7.456 0 0112 13.5v2.25" /></svg>
            </button>
            <div class="time-date-container"><span id="date"></span> | <span id="clock"></span></div>
        </div>
         <div class="marquee prayer-marquee"><div class="marquee-content" id="prayer-ticker"></div></div>
         <div class="marquee"><div class="marquee-content" id="product-ticker"></div></div>
         <header class="container">
             <h1>üçï ŸÖÿ∑ÿπŸÖ ÿßŸÑÿ£ÿµÿØŸÇÿßÿ° ü•©</h1>
             <div class="search-bar"><input type="text" id="search-input" placeholder="üîç ÿßÿ®ÿ≠ÿ´..."></div>
         </header>
         <main class="container">
             <section id="featured-section" class="hidden"><h2 class="section-title">‚≠ê ÿßŸÑÿ£ŸÉÿ´ÿ± ÿ∑ŸÑÿ®ÿßŸã</h2><div class="product-grid" id="featured-grid"></div></section>
             <section id="pizza-section"><h2 class="section-title">ÿßŸÑÿ®Ÿäÿ™ÿ≤ÿß</h2><div class="product-grid" id="pizza-grid"></div></section>
             <section id="grills-section" style="margin-top: 40px;"><h2 class="section-title">ÿßŸÑŸÖÿ¥ÿßŸàŸä</h2><div class="product-grid" id="grills-grid"></div></section>
             <section id="drinks-section" style="margin-top: 40px;"><h2 class="section-title">ÿßŸÑŸÖÿ¥ÿ±Ÿàÿ®ÿßÿ™</h2><div class="product-grid" id="drinks-grid"></div></section>
             <section id="others-section" style="margin-top: 40px;"><h2 class="section-title">ÿ≠ŸÑŸàŸäÿßÿ™</h2><div class="product-grid" id="others-grid"></div></section>
             <p id="no-results-msg" class="hidden" style="text-align:center; padding: 20px;">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÜÿ™ÿßÿ¶ÿ¨.</p>
         </main>
         <section class="cart-section container">
             <h2 class="section-title">üõí ÿ≥ŸÑÿ© ÿßŸÑŸÖÿ¥ÿ™ÿ±Ÿäÿßÿ™</h2><ul id="cart-items" style="list-style: none; padding: 0;"></ul><p id="cart-empty-msg">ÿ≥ŸÑÿ™ŸÉ ŸÅÿßÿ±ÿ∫ÿ©.</p>
             <div id="total-price-container" class="hidden" style="text-align: left; margin-top: 15px;"><strong>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: <span id="total-price">0.00 ÿØ.ÿ¨</span></strong></div>
             <div class="checkout-form" id="checkout-container" style="display: none;">
                 <div class="form-group"><label for="firstName">ÿßŸÑÿßÿ≥ŸÖ:</label><input type="text" id="firstName" required></div>
                 <div class="form-group"><label for="lastName">ÿßŸÑŸÑŸÇÿ®:</label><input type="text" id="lastName" required></div>
                 <div class="form-group"><label for="phone">ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ:</label><input type="tel" id="phone" required></div>
                 <div id="map-container"><label>ÿ≠ÿØÿØ ŸÖŸàŸÇÿπ ÿßŸÑÿ™ŸàÿµŸäŸÑ:</label><div id="map"></div></div>
                 <div class="contact-buttons">
                    <button type="button" class="contact-btn pinpoint-btn" id="pinpoint-location-btn">üìç ÿ≠ÿØÿØ ŸÖŸàŸÇÿπŸä ÿßŸÑÿ≠ÿßŸÑŸä</button>
                    <button id="whatsapp-btn" class="contact-btn whatsapp-btn">ÿ£ÿ±ÿ≥ŸÑ ÿπÿ®ÿ± Ÿàÿßÿ™ÿ≥ÿßÿ®</button>
                    <button id="messenger-btn" class="contact-btn messenger-btn">ÿ£ÿ±ÿ≥ŸÑ ÿ•ŸÑŸâ ŸÖÿ≥ŸÜÿ¨ÿ±</button>
                </div>
             </div>
         </section>
         <footer><div class="container"><p>&copy; 2025 ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÇ ŸÖÿ≠ŸÅŸàÿ∏ÿ©</p><a id="admin-login-btn">ÿØÿÆŸàŸÑ ÿßŸÑŸÖÿØŸäÿ±</a></div></footer>
    </div>
    <section id="admin-panel-section" class="hidden"><div class="container"><div class="admin-panel"><h2 class="section-title">ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ</h2><div class="admin-stats" id="admin-stats"></div><div id="admin-controls"></div><form id="add-product-form" style="border-top: 2px solid var(--primary-color); margin-top: 20px; padding-top: 20px;"><h3 style="margin-bottom: 15px;">ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨</h3><div class="form-group"><input type="text" id="new-product-name" placeholder="ÿßŸÑÿßÿ≥ŸÖ" required></div><div class="form-group"><input type="number" id="new-product-price" placeholder="ÿßŸÑÿ≥ÿπÿ±" required></div><div class="form-group"><select id="new-product-category" required style="width: 100%; padding: 10px; background: #333; color: white;"><option value="pizza">ÿ®Ÿäÿ™ÿ≤ÿß</option><option value="grills">ŸÖÿ¥ÿßŸàŸä</option><option value="drinks">ŸÖÿ¥ÿ±Ÿàÿ®ÿßÿ™</option><option value="others">ÿ≠ŸÑŸàŸäÿßÿ™</option></select></div><div class="form-group"><input type="text" id="new-product-image" placeholder="ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿµŸàÿ±ÿ©" required></div><button type="submit" class="add-to-cart-btn" style="width:100%;">ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨</button></form></div></div></section>
    <div id="login-modal" class="login-modal hidden"><div class="modal-content"><span class="close-modal-btn">&times;</span><h3>ÿØÿÆŸàŸÑ ÿßŸÑŸÖÿØŸäÿ±</h3><form id="login-form"><div class="form-group"><input type="text" id="username" placeholder="ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ" required></div><div class="form-group"><input type="password" id="password" placeholder="ŸÉŸÑŸÖÿ© ÿßŸÑÿ≥ÿ±" required></div><p id="login-error-msg" style="color: var(--secondary-color); margin-top: 10px; height: 20px;"></p><button type="submit">ÿØÿÆŸàŸÑ</button></form></div></div>
    <div id="image-modal" class="hidden"><span id="image-modal-close">&times;</span><img id="image-modal-src" src="" alt="ÿµŸàÿ±ÿ© ŸÖŸÉÿ®ÿ±ÿ©"></div>
    <div id="phone-auth-modal" class="auth-modal hidden"><div class="modal-content" id="phone-auth-content"></div></div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, deleteDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            
            const App = {
                state: { allProducts: [], cart: [], map: null, marker: null, userLocation: null, prayerTimes: null, currentPrayer: null, currentUser: null },
                services: { db: null, auth: null, productsCollectionRef: null },
                elements: {},

                init() {
                    this.cacheElements();
                    this.events.setup();
                    this.utils.updateTime(); 
                    setInterval(() => this.utils.updateTime(), 1000);
                    
                    const firebaseConfig = {
                        apiKey: "AIzaSyB7SS6R4sG--NUIkaGiEQd9VaDTh6yiQL8",
                        authDomain: "yallapizza-1e7a6.firebaseapp.com",
                        projectId: "yallapizza-1e7a6",
                        storageBucket: "yallapizza-1e7a6.firebasestorage.app",
                        messagingSenderId: "200622926370",
                        appId: "1:200622926370:web:c8c344af5ccbb14e2a387b"
                    };
                    const appId = "pizza-shop-azouze-shared";
                    
                    try {
                        const app = initializeApp(firebaseConfig);
                        this.services.db = getFirestore(app);
                        this.services.auth = getAuth(app);
                        this.services.productsCollectionRef = collection(this.services.db, `/shared_data/${appId}/products`);
                        
                        this.auth.handleAuthState();
                    } catch (e) {
                        console.error("Initialization failed:", e);
                        this.elements.loader.textContent = `ŸÅÿ¥ŸÑ ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ: ${e.message}`;
                    }
                },
                
                cacheElements() {
                    this.elements = {
                        loader: document.getElementById('loader'),
                        appContent: document.getElementById('app-content'),
                        grids: { pizza: document.getElementById('pizza-grid'), grills: document.getElementById('grills-grid'), drinks: document.getElementById('drinks-grid'), others: document.getElementById('others-grid'), featured: document.getElementById('featured-grid') },
                        prayerTicker: document.getElementById('prayer-ticker'),
                        productTicker: document.getElementById('product-ticker'),
                        phoneAuthModal: document.getElementById('phone-auth-modal'),
                        phoneAuthContent: document.getElementById('phone-auth-content'),
                    };
                },

                render: {
                    all() { this.products(); this.adminPanel(); this.cart(); App.utils.populateMarquee(); App.utils.populatePrayerTicker(); },
                    products() {
                        const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
                        const filteredProducts = App.state.allProducts.filter(p => p.name.toLowerCase().includes(searchTerm));
                        Object.values(App.elements.grids).forEach(g => { if(g) g.innerHTML = ''; });
                        let count = 0;
                        const featuredSection = document.getElementById('featured-section');
                        if (featuredSection) featuredSection.classList.add('hidden');
                        filteredProducts.forEach(p => {
                            const placeholderUrl = `https://placehold.co/600x400/212529/ffc107?text=${encodeURIComponent(p.name)}`;
                            const imageUrl = p.image || placeholderUrl;
                            const html = `<div class="product-card ${!p.isAvailable ? 'unavailable' : ''}" data-id="${p.id}"><div class="product-image-container" data-img-src="${imageUrl}">${p.isOffer ? '<div class="special-offer-tag">ÿπÿ±ÿ∂ ÿÆÿßÿµ</div>' : ''}<img src="${imageUrl}" alt="${p.name}" class="product-image" loading="lazy" onerror="this.onerror=null;this.src='${placeholderUrl}';"></div><div class="product-info"><h3>${p.name}</h3><button class="add-to-cart-btn" data-id="${p.id}" ${!p.isAvailable ? 'disabled' : ''}>ÿ£ÿ∂ŸÅ ŸÑŸÑÿ≥ŸÑÿ©</button></div></div>`;
                            if (App.elements.grids[p.category]) { App.elements.grids[p.category].innerHTML += html; count++; }
                            if (p.isOffer && App.elements.grids.featured) { App.elements.grids.featured.innerHTML += html; featuredSection.classList.remove('hidden'); }
                        });
                        document.getElementById('no-results-msg').classList.toggle('hidden', count === 0);
                    },
                    cart() {
                        const list = document.getElementById('cart-items'); if(!list) return;
                        list.innerHTML = ''; let total = 0;
                        const checkoutContainer = document.getElementById('checkout-container'), cartEmptyMsg = document.getElementById('cart-empty-msg'), totalPriceContainer = document.getElementById('total-price-container');
                        if (App.state.cart.length === 0) { cartEmptyMsg.classList.remove('hidden'); checkoutContainer.style.display = 'none'; totalPriceContainer.classList.add('hidden'); } 
                        else {
                            cartEmptyMsg.classList.add('hidden'); checkoutContainer.style.display = 'block'; totalPriceContainer.classList.remove('hidden');
                            if (!App.state.map) App.map.init();
                            App.state.cart.forEach(item => { const li = document.createElement('li'); li.innerHTML = `<span>${item.name} (x${item.quantity})</span><span>${(item.price * item.quantity).toFixed(2)} ÿØ.ÿ¨</span><button class="remove-item-btn" data-id="${item.id}">X</button>`; list.appendChild(li); total += item.price * item.quantity; });
                        }
                        document.getElementById('total-price').textContent = total.toFixed(2);
                    },
                    adminPanel() {
                        const stats = document.getElementById('admin-stats'), controls = document.getElementById('admin-controls'); if (!stats || !controls) return;
                        stats.innerHTML = `<div class="stat-item"><h4>ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä</h4><p>${App.state.allProducts.length}</p></div>` + ['pizza', 'grills', 'drinks', 'others'].map(cat => `<div class="stat-item"><h4>${cat.charAt(0).toUpperCase() + cat.slice(1)}</h4><p>${App.state.allProducts.filter(p=>p.category===cat).length}</p></div>`).join('');
                        controls.innerHTML = '<h3>ÿßŸÑÿ™ÿ≠ŸÉŸÖ ÿ®ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</h3>';
                        App.state.allProducts.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => { controls.innerHTML += `<div class="admin-product-controls" style="opacity:${p.isAvailable ? 1 : 0.7}"><span>${p.name}</span><div class="admin-controls-buttons"><label for="edit-image-${p.id}" class="edit-image-label">ÿµŸàÿ±ÿ©</label><input type="file" id="edit-image-${p.id}" class="edit-image-input" data-id="${p.id}" accept="image/*"><button class="toggle-status-btn ${p.isAvailable ? 'toggle-status-btn-available' : 'toggle-status-btn-unavailable'}" data-id="${p.id}">${p.isAvailable ? 'ŸÖÿ™ŸàŸÅÿ±' : 'ŸÜŸÅÿ∞'}</button><button class="toggle-offer-btn" data-id="${p.id}" style="background-color:${p.isOffer ? 'var(--success-color)' : '#fd7e14'}">${p.isOffer ? 'ÿπÿ±ÿ∂ ÿπÿßÿØŸä' : 'ÿπÿ±ÿ∂ ÿÆÿßÿµ'}</button><button class="duplicate-btn" data-id="${p.id}">ŸÜÿ≥ÿÆ</button><button class="delete-btn" data-id="${p.id}">ÿ≠ÿ∞ŸÅ</button></div></div>`; });
                    },
                    phoneAuthModal() {
                        const content = App.elements.phoneAuthContent;
                        if(App.state.currentUser) {
                            content.innerHTML = `<span class="close-modal-btn">&times;</span><h3>ÿ≠ÿ≥ÿßÿ®Ÿä</h3><p class="text-center mb-4">ÿ£ŸáŸÑÿßŸã ÿ®ŸÉÿå ${App.state.currentUser.phoneNumber}</p><button id="logout-btn" class="bg-red-600 text-white w-full py-2 rounded-lg">ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨</button>`;
                        } else {
                            content.innerHTML = `<span class="close-modal-btn">&times;</span><h3>ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ</h3><div id="phone-entry-view"><p class="text-gray-400 mb-4">ÿ£ÿØÿÆŸÑ ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅŸÉ ŸÑÿ™ÿµŸÑŸÉ ÿ±ÿ≥ÿßŸÑÿ© ÿ™ÿ£ŸÉŸäÿØ</p><div class="form-group"><input type="tel" id="phone-number-input" placeholder="ŸÖÿ´ÿßŸÑ: 0775210534" class="text-left"></div><div id="recaptcha-container"></div><button id="send-code-btn" class="w-full mt-4 py-2 bg-indigo-600 text-white rounded-lg">ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÉŸàÿØ</button></div><div id="code-entry-view" class="hidden"><p class="text-gray-400 mb-4">ÿ£ÿØÿÆŸÑ ÿßŸÑŸÉŸàÿØ ÿßŸÑÿ∞Ÿä ŸàÿµŸÑŸÉ ÿπÿ®ÿ± SMS</p><div class="form-group"><input type="text" id="verification-code-input" placeholder="ÿ±ŸÖÿ≤ ÿßŸÑÿ™ÿ£ŸÉŸäÿØ" class="text-center"></div><button id="verify-code-btn" class="w-full mt-4 py-2 bg-green-600 text-white rounded-lg">ÿ™ÿ£ŸÉŸäÿØ ÿßŸÑÿØÿÆŸàŸÑ</button></div>`;
                        }
                        App.elements.phoneAuthModal.classList.remove('hidden');
                    }
                },
                
                utils: {
                    updateTime() {
                        const now = new Date();
                        const clockEl = document.getElementById('clock');
                        const dateEl = document.getElementById('date');
                        if(clockEl) clockEl.textContent = now.toLocaleTimeString('ar-DZ', { hour: '2-digit', minute: '2-digit' });
                        if(dateEl) dateEl.textContent = now.toLocaleDateString('ar-DZ', { weekday: 'long', day: 'numeric', month: 'long' });
                        App.prayer.checkPrayerTimeForMarquee(now);
                    },
                    populateMarquee() {
                        const marqueeContent = document.getElementById('product-ticker');
                        if (!marqueeContent) return;
                        if(App.state.currentPrayer) {
                             marqueeContent.innerHTML = `<span>üïå ÿ≠ÿßŸÜ ÿßŸÑÿ¢ŸÜ ŸàŸÇÿ™ ÿµŸÑÿßÿ© ${App.state.currentPrayer} ÿ≠ÿ≥ÿ® ÿ™ŸàŸÇŸäÿ™ ÿ®ÿ±ÿ¨ ÿ®Ÿàÿπÿ±Ÿäÿ±Ÿäÿ¨</span>`;
                        } else {
                            marqueeContent.innerHTML = App.state.allProducts.map(p => `<span>${p.isOffer ? '‚≠ê' : 'üçï'} ${p.name}</span>`).join('');
                        }
                    },
                    populatePrayerTicker() {
                        const prayerTicker = App.elements.prayerTicker;
                        if (!prayerTicker || !App.state.prayerTimes) return;
                        const prayerOrder = ["Fajr", "Dhuhr", "Asr", "Maghrib", "Isha"];
                        const prayerNamesAr = { "Fajr": "ÿßŸÑŸÅÿ¨ÿ±", "Dhuhr": "ÿßŸÑÿ∏Ÿáÿ±", "Asr": "ÿßŸÑÿπÿµÿ±", "Maghrib": "ÿßŸÑŸÖÿ∫ÿ±ÿ®", "Isha": "ÿßŸÑÿπÿ¥ÿßÿ°" };
                        prayerTicker.innerHTML = prayerOrder.map(key => `<span>${prayerNamesAr[key]}: ${App.state.prayerTimes[key]}</span>`).join('');
                    }
                },

                map: {
                    init() {
                        if (document.getElementById('map') && !App.state.map) {
                            const defaultCoords = [36.072, 4.772];
                            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' });
                            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' });
                            App.state.map = L.map('map', { layers: [osmLayer] }).setView(defaultCoords, 13);
                            L.control.layers({ "ÿÆÿ±Ÿäÿ∑ÿ© ÿπÿßÿØŸäÿ©": osmLayer, "ÿµŸàÿ± ŸÅÿ∂ÿßÿ¶Ÿäÿ©": satelliteLayer }).addTo(App.state.map);
                            App.state.marker = L.marker(defaultCoords, { draggable: true }).addTo(App.state.map);
                            App.state.userLocation = { lat: defaultCoords[0], lng: defaultCoords[1] };
                            App.state.marker.on('dragend', (e) => App.state.userLocation = e.target.getLatLng());
                        }
                    }
                },
                
                data: {
                    listenForChanges() {
                        onSnapshot(App.services.productsCollectionRef, (snapshot) => {
                            if (snapshot.empty) { this.initializeDefault(); }
                            App.state.allProducts = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
                            App.render.all();
                            App.elements.loader.classList.add('hidden');
                            App.elements.appContent.classList.remove('hidden');
                        }, (error) => { console.error("Firestore listener error:", error); App.elements.loader.textContent = "ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ ÿ®ÿßŸÑŸÖÿ™ÿ¨ÿ±."; });
                    },
                    async initializeDefault() {
                        const defaultProducts = [
                             { name: 'ÿ®Ÿäÿ™ÿ≤ÿß ŸÖÿßÿ±ÿ∫ÿ±Ÿäÿ™ÿß', price: 800, image: 'https://images.unsplash.com/photo-1574071318508-1cdbab80d002?q=80&w=2069&auto=format&fit=crop', category: 'pizza', isAvailable: true, isOffer: true },
                             { name: 'ÿ∑ÿ®ŸÇ ŸÖÿ¥ÿßŸàŸä ŸÖÿ¥ŸÉŸÑ', price: 1800, image: 'https://images.unsplash.com/photo-1628345121123-9383445837e2?q=80&w=1974&auto=format&fit=crop', category: 'grills', isAvailable: true, isOffer: true },
                             { name: 'ÿπÿµŸäÿ± ÿ®ÿ±ÿ™ŸÇÿßŸÑ ÿ∑ÿßÿ≤ÿ¨', price: 250, image: 'https://images.unsplash.com/photo-1600271886742-f049cd451bba?q=80&w=1887&auto=format&fit=crop', category: 'drinks', isAvailable: true, isOffer: false },
                        ];
                        for (const product of defaultProducts) {
                            try { await addDoc(App.services.productsCollectionRef, product); } 
                            catch(e) { console.error("Error adding default product:", e); }
                        }
                    }
                },
                
                auth: {
                    handleAuthState() {
                        onAuthStateChanged(App.services.auth, user => {
                            App.state.currentUser = user;
                            if (user) {
                                const phoneInput = document.getElementById('phone');
                                if(phoneInput) phoneInput.value = user.phoneNumber || '';
                            }
                            App.data.listenForChanges();
                            App.prayer.fetchTimes();
                        });
                    },
                    setupRecaptcha() {
                        if (window.recaptchaVerifier) { window.recaptchaVerifier.clear(); }
                        window.recaptchaVerifier = new RecaptchaVerifier(App.services.auth, 'recaptcha-container', {
                            'size': 'invisible', 'callback': () => console.log("reCAPTCHA solved")
                        });
                    },
                    async sendVerificationCode() {
                        const phoneInput = document.getElementById('phone-number-input');
                        let phoneNumber = phoneInput.value.trim();
                        if (!/^(05|06|07)\d{8}$/.test(phoneNumber)) { alert("ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿ±ŸÇŸÖ Ÿáÿßÿ™ŸÅ ÿ¨ÿ≤ÿßÿ¶ÿ±Ÿä ÿµÿ≠Ÿäÿ≠."); return; }
                        phoneNumber = `+213${phoneNumber.substring(1)}`;
                        App.auth.setupRecaptcha();
                        const appVerifier = window.recaptchaVerifier;
                        try {
                            window.confirmationResult = await signInWithPhoneNumber(App.services.auth, phoneNumber, appVerifier);
                            alert('ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ŸÉŸàÿØ ÿßŸÑÿ™ÿ£ŸÉŸäÿØ.');
                            document.getElementById('phone-entry-view').classList.add('hidden');
                            document.getElementById('code-entry-view').classList.remove('hidden');
                        } catch (error) { console.error("Error sending SMS:", error); alert("ŸÅÿ¥ŸÑ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÉŸàÿØ. ÿ≠ÿßŸàŸÑ ŸÑÿßÿ≠ŸÇÿßŸã."); }
                    },
                    async verifyCode() {
                        const code = document.getElementById('verification-code-input').value.trim();
                        if (code.length !== 6) { alert("ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÉŸàÿØ ÿßŸÑŸÖŸÉŸàŸÜ ŸÖŸÜ 6 ÿ£ÿ±ŸÇÿßŸÖ."); return; }
                        try { await window.confirmationResult.confirm(code); alert("ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ÿ®ŸÜÿ¨ÿßÿ≠!"); App.elements.phoneAuthModal.classList.add('hidden');
                        } catch (error) { console.error("Error verifying code:", error); alert("ÿßŸÑŸÉŸàÿØ ÿ∫Ÿäÿ± ÿµÿ≠Ÿäÿ≠."); }
                    },
                    async logout() { await App.services.auth.signOut(); alert("ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨."); App.elements.phoneAuthModal.classList.add('hidden'); }
                },

                prayer: {
                    async fetchTimes() {
                        try {
                            const response = await fetch('https://api.aladhan.com/v1/timingsByCity?city=Bordj%20Bou%20Arreridj&country=DZ&method=3');
                            if (!response.ok) throw new Error('Network response was not ok');
                            const data = await response.json();
                            if (data.data.timings) { App.state.prayerTimes = data.data.timings; App.utils.populatePrayerTicker(); }
                        } catch (error) { console.error("Could not fetch prayer times:", error); }
                    },
                    checkPrayerTimeForMarquee(now) {
                         if (!App.state.prayerTimes) return;
                        const currentTime = now.toTimeString().substring(0, 5);
                        const prayerNamesAr = { "Fajr": "ÿßŸÑŸÅÿ¨ÿ±", "Dhuhr": "ÿßŸÑÿ∏Ÿáÿ±", "Asr": "ÿßŸÑÿπÿµÿ±", "Maghrib": "ÿßŸÑŸÖÿ∫ÿ±ÿ®", "Isha": "ÿßŸÑÿπÿ¥ÿßÿ°" };
                        let prayerNow = null;
                        for (const prayerKey in prayerNamesAr) { if (App.state.prayerTimes[prayerKey] === currentTime) { prayerNow = prayerNamesAr[prayerKey]; break; } }
                        
                        if (prayerNow && App.state.currentPrayer !== prayerNow) {
                            App.state.currentPrayer = prayerNow;
                            App.utils.populateMarquee();
                            setTimeout(() => { App.state.currentPrayer = null; App.utils.populateMarquee(); }, 120000);
                        }
                    }
                },

                events: {
                    setup() {
                        document.body.addEventListener('click', (e) => this.handleBodyClick(e));
                        document.getElementById('login-form').addEventListener('submit', (e) => this.handleLogin(e));
                        document.getElementById('add-product-form').addEventListener('submit', (e) => this.handleAddProduct(e));
                        document.getElementById('admin-panel-section').addEventListener('change', (e) => this.handleAdminImageChange(e));
                        document.getElementById('search-input').addEventListener('input', () => App.render.products());
                    },
                    async handleBodyClick(e) {
                        const target = e.target; const id = target.dataset.id; if (!target) return;
                        if (target.id === 'profile-btn') { App.render.phoneAuthModal();
                        } else if (target.id === 'close-auth-modal') { App.elements.phoneAuthModal.classList.add('hidden');
                        } else if (target.id === 'send-code-btn') { App.auth.sendVerificationCode();
                        } else if (target.id === 'verify-code-btn') { App.auth.verifyCode();
                        } else if (target.id === 'logout-btn') { App.auth.logout();
                        } else if (target.classList.contains('add-to-cart-btn')) { const product = App.state.allProducts.find(p => p.id === id); if (product && product.isAvailable) { const item = App.state.cart.find(i => i.id === id); if (item) item.quantity++; else App.state.cart.push({ ...product, quantity: 1 }); App.render.cart(); }
                        } else if (target.classList.contains('remove-item-btn')) { App.state.cart = App.state.cart.filter(item => item.id !== id); App.render.cart();
                        } else if (target.closest('.product-image-container')) { document.getElementById('image-modal-src').src = target.closest('.product-image-container').dataset.imgSrc; document.getElementById('image-modal').classList.remove('hidden');
                        } else if (target.id === 'image-modal-close' || target.id === 'image-modal') { document.getElementById('image-modal').classList.add('hidden');
                        } else if (target.id === 'admin-login-btn') { document.getElementById('login-modal').classList.remove('hidden');
                        } else if (target.classList.contains('close-modal-btn')) { document.getElementById('login-modal').classList.add('hidden');
                        } else if (target.id === 'pinpoint-location-btn') { if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(pos => { const { latitude, longitude } = pos.coords; App.state.userLocation = { lat: latitude, lng: longitude }; if(App.state.map){App.state.map.setView([latitude, longitude], 16); App.state.marker.setLatLng([latitude, longitude]);}}, () => alert('ŸÑÿß ŸäŸÖŸÉŸÜ ÿ™ÿ≠ÿØŸäÿØ ÿßŸÑŸÖŸàŸÇÿπ.'), { enableHighAccuracy: true }); }
                        } else if (target.id === 'whatsapp-btn') {
                            const fName = document.getElementById('firstName').value, lName = document.getElementById('lastName').value, phone = document.getElementById('phone').value; 
                            if (!fName || !lName || !phone) { alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿßÿ≥ŸÖÿå ÿßŸÑŸÑŸÇÿ®ÿå Ÿàÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ.'); return; }
                            const ts = new Date().toLocaleString('ar-DZ', { dateStyle: 'full', timeStyle: 'short' }); let msg = `*ÿ∑ŸÑÿ® ÿ¨ÿØŸäÿØ* üõéÔ∏è\n*ÿßŸÑÿ™ÿßÿ±ŸäÿÆ:* ${ts}\n*ÿßŸÑÿ≤ÿ®ŸàŸÜ:* ${fName} ${lName}\n*ÿßŸÑŸáÿßÿ™ŸÅ:* ${phone}\n\n*ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™:*\n`; App.state.cart.forEach(i => msg += `- ${i.name} (x${i.quantity}) = ${(i.price * i.quantity).toFixed(2)} ÿØ.ÿ¨\n`); msg += `\n*ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: ${document.getElementById('total-price').textContent} ÿØ.ÿ¨*`; if (App.state.userLocation) { msg += `\n\n*ÿßŸÑŸÖŸàŸÇÿπ:* https://www.google.com/maps?q=${App.state.userLocation.lat},${App.state.userLocation.lng}`; }
                            window.open(`https://wa.me/213775210534?text=${encodeURIComponent(msg)}`, '_blank');
                        } else if (target.id === 'messenger-btn') {
                            const fName = document.getElementById('firstName').value, lName = document.getElementById('lastName').value, phone = document.getElementById('phone').value; 
                            if (!fName || !lName || !phone) { alert('ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿßÿ≥ŸÖÿå ÿßŸÑŸÑŸÇÿ®ÿå Ÿàÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ.'); return; }
                            const ts = new Date().toLocaleString('ar-DZ', { dateStyle: 'full', timeStyle: 'short' }); let msg = `*ÿ∑ŸÑÿ® ÿ¨ÿØŸäÿØ* üõéÔ∏è\n*ÿßŸÑÿ™ÿßÿ±ŸäÿÆ:* ${ts}\n*ÿßŸÑÿ≤ÿ®ŸàŸÜ:* ${fName} ${lName}\n*ÿßŸÑŸáÿßÿ™ŸÅ:* ${phone}\n\n*ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™:*\n`; App.state.cart.forEach(i => msg += `- ${i.name} (x${i.quantity}) = ${(i.price * i.quantity).toFixed(2)} ÿØ.ÿ¨\n`); msg += `\n*ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: ${document.getElementById('total-price').textContent} ÿØ.ÿ¨*`; if (App.state.userLocation) { msg += `\n\n*ÿßŸÑŸÖŸàŸÇÿπ:* https://www.google.com/maps?q=${App.state.userLocation.lat},${App.state.userLocation.lng}`; }
                            
                            const tempInput = document.createElement('textarea');
                            tempInput.value = msg;
                            document.body.appendChild(tempInput);
                            tempInput.select();
                            document.execCommand('copy');
                            document.body.removeChild(tempInput);
                            alert('ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿ∑ŸÑÿ®! ÿ≥Ÿäÿ™ŸÖ ÿßŸÑÿ¢ŸÜ ŸÅÿ™ÿ≠ ÿßŸÑŸÖÿ≥ŸÜÿ¨ÿ± ŸÑÿ™ÿ™ŸÖŸÉŸÜ ŸÖŸÜ ŸÑÿµŸÇ ÿßŸÑÿ±ÿ≥ÿßŸÑÿ©.');
                            window.open('https://m.me/hsam.trshwn', '_blank');
                        }
                        else if (target.closest('#admin-controls')) {
                            if (!id) return;
                            const productRef = doc(App.services.db, `/shared_data/pizza-shop-azouze-shared/products`, id);
                            if (target.classList.contains('delete-btn')) { if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØÿü')) await deleteDoc(productRef); } 
                            else if (target.classList.contains('toggle-status-btn')) { const p = App.state.allProducts.find(p => p.id === id); if(p) await updateDoc(productRef, { isAvailable: !p.isAvailable }); }
                            else if (target.classList.contains('toggle-offer-btn')) { const p = App.state.allProducts.find(p => p.id === id); if(p) await updateDoc(productRef, { isOffer: !p.isOffer }); }
                            else if (target.classList.contains('duplicate-btn')) { const p = App.state.allProducts.find(p => p.id === id); if (p) { const { id: oldId, ...productData } = p; await addDoc(App.services.productsCollectionRef, {...productData, name: `${p.name} (ŸÜÿ≥ÿÆÿ©)`}); } }
                        }
                    },
                    handleLogin(e) { e.preventDefault(); if (document.getElementById('username').value.trim() === 'azouze' && document.getElementById('password').value.trim() === '19891989') { document.getElementById('login-modal').classList.add('hidden'); document.getElementById('admin-panel-section').classList.remove('hidden'); document.querySelector('footer').classList.add('hidden'); } else { document.getElementById('login-error-msg').textContent = 'ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿÆÿßÿ∑ÿ¶ÿ©.'; } },
                    async handleAddProduct(e) { e.preventDefault(); const newProduct = { name: document.getElementById('new-product-name').value, price: parseFloat(document.getElementById('new-product-price').value), category: document.getElementById('new-product-category').value, image: document.getElementById('new-product-image').value, isAvailable: true, isOffer: false }; if (newProduct.name && newProduct.price > 0 && newProduct.image) { await addDoc(App.services.productsCollectionRef, newProduct); e.target.reset(); } else { alert('Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÑ ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠.'); } },
                    handleAdminImageChange(e) { if (e.target.classList.contains('edit-image-input')) { const id = e.target.dataset.id; const file = e.target.files[0]; if (!file || !id) return; const reader = new FileReader(); reader.onload = (event) => { const productRef = doc(App.services.db, `/shared_data/pizza-shop-azouze-shared/products`, id); updateDoc(productRef, { image: event.target.result }); }; reader.readAsDataURL(file); } }
                },
            };

            App.init();
        });
    </script>
</body>
</html>
