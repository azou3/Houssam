<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ù…ØªØ¬Ø± Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ - Ù…Ø¨Ø§Ø´Ø±</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        :root {
            --primary-color: #ffc107; --secondary-color: #c82333; --dark-color: #212529; --light-color: #f8f9fa;
            --success-color: #28a745; --grey-color: #495057; --font-family: 'Tajawal', sans-serif;
        }
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { overflow-x: hidden; }
        body {
            font-family: var(--font-family); background-color: var(--dark-color); color: var(--light-color);
            background: linear-gradient(rgba(0, 0, 0, 0.88), rgba(0, 0, 0, 0.88)), url('https://images.unsplash.com/photo-1513104890138-7c749659a591?q=80&w=2070&auto=format&fit=crop') center center/cover no-repeat fixed;
        }
        .container { max-width: 1200px; margin: auto; padding: 0 15px; }
        .hidden { display: none !important; }
        .time-date-container { text-align: center; color: #ccc; padding: 10px 0; font-size: 1rem; background-color: rgba(0,0,0,0.2); }
        #clock, #date { display: inline-block; margin: 0 10px; }
        .marquee { background-color: var(--secondary-color); color: white; padding: 10px; overflow: hidden; white-space: nowrap; }
        .marquee-content { display: inline-block; padding-left: 100%; animation: marquee 45s linear infinite; }
        #map { height: 280px; border-radius: 10px; border: 2px solid var(--primary-color); margin-top:10px; z-index: 1; }
        .leaflet-control-layers { border-radius: 5px; opacity: 0.8; }
        .pinpoint-btn { width: 100%; padding: 12px; margin-top: 10px; font-size: 1rem; background-color: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; }
        #loader { position: fixed; top:0; left: 0; width: 100%; height: 100%; background: var(--dark-color); display: flex; justify-content: center; align-items: center; text-align: center; padding-top: 40px; font-size: 1.5rem; color: var(--primary-color); z-index: 9999; }
        header { text-align: center; padding: 20px 15px; }
        header h1 { font-size: 2.2rem; color: var(--primary-color); text-shadow: 2px 2px 4px rgba(0,0,0,0.7); }
        .search-bar { margin: 15px auto; max-width: 600px; }
        .search-bar input { width: 100%; padding: 12px; background-color: rgba(255,255,255,0.1); border: 1px solid var(--primary-color); border-radius: 8px; color: white; font-size: 1rem; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 15px; }
        .product-card { background-color: var(--dark-color); border: 1px solid var(--grey-color); border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: flex; flex-direction: column; position: relative; }
        .product-card.unavailable { opacity: 0.6; }
        .product-card.unavailable::after { content: 'ØºÙŠØ± Ù…ØªÙˆÙØ±'; position: absolute; top: 40%; left: 50%; transform: translateX(-50%) translateY(-50%) rotate(-15deg); background-color: rgba(0,0,0,0.7); color: white; padding: 10px 20px; border-radius: 5px; font-weight: bold; }
        .product-image-container { position: relative; cursor: pointer; }
        .product-image { width: 100%; height: 180px; object-fit: cover; }
        .special-offer-tag { position: absolute; top: 10px; left: 10px; background-color: var(--secondary-color); color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; }
        .product-info { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; text-align: center; }
        .product-info h3 { font-size: 1.3rem; color: var(--primary-color); margin-bottom: 10px; }
        .add-to-cart-btn { background-color: var(--primary-color); color: var(--dark-color); border: none; padding: 12px; font-size: 1rem; font-weight: bold; border-radius: 8px; cursor: pointer; margin-top: auto; }
        h2.section-title { text-align: center; font-size: 2rem; color: var(--primary-color); margin-bottom: 20px; }
        h2.section-title::after { content: ''; display: block; width: 60px; height: 3px; background: var(--secondary-color); margin: 8px auto 0; border-radius: 2px; }
        .cart-section { background-color: rgba(0,0,0,0.75); padding: 20px; margin-top: 40px; border-radius: 15px; border-top: 4px solid var(--primary-color); }
        .contact-buttons { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--grey-color); display: flex; flex-direction: column; gap: 10px; }
        .form-group { margin-top: 15px; }
        .admin-panel { background-color: #1c1c1c; padding: 15px; margin-top: 20px; border-radius: 10px; border: 1px solid var(--primary-color); }
        .admin-stats { display: flex; flex-wrap: wrap; justify-content: space-around; background-color: var(--dark-color); padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; gap: 10px; }
        .stat-item h4 { color: var(--primary-color); font-size: 0.8rem; } .stat-item p { font-size: 1.4rem; font-weight: bold; }
        .admin-product-controls { display: grid; grid-template-columns: 1fr; gap: 10px; align-items: center; padding: 10px; border-bottom: 1px solid var(--grey-color); }
        .admin-controls-buttons { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; }
        .admin-controls-buttons button, .admin-controls-buttons label { padding: 8px; cursor: pointer; border-radius: 5px; border: none; font-size: 0.8rem; text-align: center; }
        .delete-btn { background-color: var(--secondary-color); color: white; }
        .toggle-status-btn-available { background-color: var(--success-color); color: white; }
        .toggle-status-btn-unavailable { background-color: var(--grey-color); color: white; }
        .duplicate-btn { background-color: #007bff; color: white; }
        .toggle-offer-btn { background-color: #fd7e14; color: white; }
        .edit-image-label { background-color: #17a2b8; color: white; display: inline-block; }
        .admin-controls-buttons input[type="file"] { display: none; }
        #image-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 2000; }
        #image-modal img { max-width: 90%; max-height: 80%; border-radius: 10px; border: 3px solid var(--primary-color); }
        #image-modal-close { position: absolute; top: 20px; right: 30px; color: white; font-size: 2.5rem; cursor: pointer; }
    </style>
</head>
<body>
    <div id="loader" class="container">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…ØªØ¬Ø±...</div>

    <div id="app-content" class="hidden">
         <div class="time-date-container"><span id="date"></span> | <span id="clock"></span></div>
         <div class="marquee"><div class="marquee-content"></div></div>
         <header class="container">
             <h1>ğŸ• Ù…Ø·Ø¹Ù… Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ğŸ¥©</h1>
             <div class="search-bar"><input type="text" id="search-input" placeholder="ğŸ” Ø§Ø¨Ø­Ø«..."></div>
         </header>
         <main class="container">
             <section id="featured-section" class="hidden"><h2 class="section-title">â­ Ø§Ù„Ø£ÙƒØ«Ø± Ø·Ù„Ø¨Ø§Ù‹</h2><div class="product-grid" id="featured-grid"></div></section>
             <section id="pizza-section"><h2 class="section-title">Ø§Ù„Ø¨ÙŠØªØ²Ø§</h2><div class="product-grid" id="pizza-grid"></div></section>
             <section id="grills-section" style="margin-top: 40px;"><h2 class="section-title">Ø§Ù„Ù…Ø´Ø§ÙˆÙŠ</h2><div class="product-grid" id="grills-grid"></div></section>
             <section id="drinks-section" style="margin-top: 40px;"><h2 class="section-title">Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª</h2><div class="product-grid" id="drinks-grid"></div></section>
             <section id="others-section" style="margin-top: 40px;"><h2 class="section-title">Ø­Ù„ÙˆÙŠØ§Øª</h2><div class="product-grid" id="others-grid"></div></section>
             <p id="no-results-msg" class="hidden" style="text-align:center; padding: 20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</p>
         </main>
         <section class="cart-section container">
             <h2 class="section-title">ğŸ›’ Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h2><ul id="cart-items" style="list-style: none; padding: 0;"></ul><p id="cart-empty-msg">Ø³Ù„ØªÙƒ ÙØ§Ø±ØºØ©.</p>
             <div id="total-price-container" class="hidden" style="text-align: left; margin-top: 15px;"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span id="total-price">0.00 Ø¯.Ø¬</span></strong></div>
             <div class="checkout-form" id="checkout-container" style="display: none;">
                 <div class="form-group"><label for="firstName">Ø§Ù„Ø§Ø³Ù…:</label><input type="text" id="firstName" required></div>
                 <div class="form-group"><label for="lastName">Ø§Ù„Ù„Ù‚Ø¨:</label><input type="text" id="lastName" required></div>
                 <div id="map-container"><label>Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙˆØµÙŠÙ„:</label><div id="map"></div><button type="button" class="pinpoint-btn" id="pinpoint-location-btn">ğŸ“ Ø­Ø¯Ø¯ Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ</button></div>
                 <div class="contact-buttons"><button id="whatsapp-btn" class="contact-btn whatsapp-btn">Ø£Ø±Ø³Ù„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨</button><a href="https://m.me/hsam.trshwn" target="_blank" class="contact-btn messenger-btn">ØªÙˆØ§ØµÙ„ Ø¹Ø¨Ø± Ù…Ø³Ù†Ø¬Ø±</a></div>
             </div>
         </section>
         <footer><div class="container"><p>&copy; 2025 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</p><a id="admin-login-btn">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</a></div></footer>
    </div>
    <section id="admin-panel-section" class="hidden"><div class="container"><div class="admin-panel"><h2 class="section-title">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2><div class="admin-stats" id="admin-stats"></div><div id="admin-controls"></div><form id="add-product-form" style="border-top: 2px solid var(--primary-color); margin-top: 20px; padding-top: 20px;"><h3 style="margin-bottom: 15px;">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬</h3><div class="form-group"><input type="text" id="new-product-name" placeholder="Ø§Ù„Ø§Ø³Ù…" required></div><div class="form-group"><input type="number" id="new-product-price" placeholder="Ø§Ù„Ø³Ø¹Ø±" required></div><div class="form-group"><select id="new-product-category" required style="width: 100%; padding: 10px; background: #333; color: white;"><option value="pizza">Ø¨ÙŠØªØ²Ø§</option><option value="grills">Ù…Ø´Ø§ÙˆÙŠ</option><option value="drinks">Ù…Ø´Ø±ÙˆØ¨Ø§Øª</option><option value="others">Ø­Ù„ÙˆÙŠØ§Øª</option></select></div><div class="form-group"><input type="text" id="new-product-image" placeholder="Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø©" required></div><button type="submit" class="add-to-cart-btn" style="width:100%;">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬</button></form></div></div></section>
    <div id="login-modal" class="login-modal hidden"><div class="login-content"><span class="close-modal-btn">&times;</span><h3>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙŠØ±</h3><form id="login-form"><div class="form-group"><input type="text" id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" required></div><div class="form-group"><input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±" required></div><p id="login-error-msg" style="color: var(--secondary-color); margin-top: 10px; height: 20px;"></p><button type="submit">Ø¯Ø®ÙˆÙ„</button></form></div></div>
    <div id="image-modal" class="hidden"><span id="image-modal-close">&times;</span><img id="image-modal-src" src="" alt="ØµÙˆØ±Ø© Ù…ÙƒØ¨Ø±Ø©"></div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, deleteDoc, updateDoc, setDoc, enableNetwork } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const App = {
            state: {
                allProducts: [],
                cart: [],
                map: null,
                marker: null,
                userLocation: null,
            },
            
            services: {
                db: null,
                auth: null,
                productsCollectionRef: null,
            },

            elements: {
                loader: document.getElementById('loader'),
                appContent: document.getElementById('app-content'),
                grids: {
                    pizza: document.getElementById('pizza-grid'),
                    grills: document.getElementById('grills-grid'),
                    drinks: document.getElementById('drinks-grid'),
                    others: document.getElementById('others-grid'),
                    featured: document.getElementById('featured-grid')
                },
            },

            render: {
                all() {
                    this.products();
                    this.adminPanel();
                    this.cart();
                    App.utils.populateMarquee();
                },
                products() {
                    const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
                    const filteredProducts = App.state.allProducts.filter(p => p.name.toLowerCase().includes(searchTerm));
                    Object.values(App.elements.grids).forEach(g => { if(g) g.innerHTML = ''; });
                    let count = 0;
                    const featuredSection = document.getElementById('featured-section');
                    if (featuredSection) featuredSection.classList.add('hidden');
                    filteredProducts.forEach(p => {
                        const html = `<div class="product-card ${!p.isAvailable ? 'unavailable' : ''}" data-id="${p.id}"><div class="product-image-container" data-img-src="${p.image}">${p.isOffer ? '<div class="special-offer-tag">Ø¹Ø±Ø¶ Ø®Ø§Øµ</div>' : ''}<img src="${p.image}" alt="${p.name}" class="product-image" loading="lazy"></div><div class="product-info"><h3>${p.name}</h3><p class="product-price">${p.price.toFixed(2)} Ø¯.Ø¬</p><button class="add-to-cart-btn" data-id="${p.id}" ${!p.isAvailable ? 'disabled' : ''}>Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button></div></div>`;
                        if (App.elements.grids[p.category]) { App.elements.grids[p.category].innerHTML += html; count++; }
                        if (p.isOffer && App.elements.grids.featured) { App.elements.grids.featured.innerHTML += html; featuredSection.classList.remove('hidden'); }
                    });
                    document.getElementById('no-results-msg').classList.toggle('hidden', count === 0);
                },
                cart() {
                    const list = document.getElementById('cart-items'); if(!list) return;
                    list.innerHTML = ''; let total = 0;
                    const checkoutContainer = document.getElementById('checkout-container'), cartEmptyMsg = document.getElementById('cart-empty-msg'), totalPriceContainer = document.getElementById('total-price-container');
                    if (App.state.cart.length === 0) { cartEmptyMsg.classList.remove('hidden'); checkoutContainer.style.display = 'none'; totalPriceContainer.classList.add('hidden'); } 
                    else {
                        cartEmptyMsg.classList.add('hidden'); checkoutContainer.style.display = 'block'; totalPriceContainer.classList.remove('hidden');
                        if (!App.state.map) App.map.init();
                        App.state.cart.forEach(item => { const li = document.createElement('li'); li.innerHTML = `<span>${item.name} (x${item.quantity})</span><span>${(item.price * item.quantity).toFixed(2)} Ø¯.Ø¬</span><button class="remove-item-btn" data-id="${item.id}">X</button>`; list.appendChild(li); total += item.price * item.quantity; });
                    }
                    document.getElementById('total-price').textContent = total.toFixed(2);
                },
                adminPanel() {
                    const stats = document.getElementById('admin-stats'), controls = document.getElementById('admin-controls'); if (!stats || !controls) return;
                    stats.innerHTML = `<div class="stat-item"><h4>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</h4><p>${App.state.allProducts.length}</p></div>` + ['pizza', 'grills', 'drinks', 'others'].map(cat => `<div class="stat-item"><h4>${cat.charAt(0).toUpperCase() + cat.slice(1)}</h4><p>${App.state.allProducts.filter(p=>p.category===cat).length}</p></div>`).join('');
                    controls.innerHTML = '<h3>Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h3>';
                    App.state.allProducts.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => { controls.innerHTML += `<div class="admin-product-controls" style="opacity:${p.isAvailable ? 1 : 0.7}"><span>${p.name}</span><div class="admin-controls-buttons"><label for="edit-image-${p.id}" class="edit-image-label">ØµÙˆØ±Ø©</label><input type="file" id="edit-image-${p.id}" class="edit-image-input" data-id="${p.id}" accept="image/*"><button class="toggle-status-btn ${p.isAvailable ? 'toggle-status-btn-available' : 'toggle-status-btn-unavailable'}" data-id="${p.id}">${p.isAvailable ? 'Ù…ØªÙˆÙØ±' : 'Ù†ÙØ°'}</button><button class="toggle-offer-btn" data-id="${p.id}" style="background-color:${p.isOffer ? 'var(--success-color)' : '#fd7e14'}">${p.isOffer ? 'Ø¹Ø±Ø¶ Ø¹Ø§Ø¯ÙŠ' : 'Ø¹Ø±Ø¶ Ø®Ø§Øµ'}</button><button class="duplicate-btn" data-id="${p.id}">Ù†Ø³Ø®</button><button class="delete-btn" data-id="${p.id}">Ø­Ø°Ù</button></div></div>`; });
                }
            },
            
            utils: {
                updateTime() {
                    const now = new Date();
                    const clockEl = document.getElementById('clock');
                    const dateEl = document.getElementById('date');
                    if(clockEl) clockEl.textContent = now.toLocaleTimeString('ar-DZ', { hour: '2-digit', minute: '2-digit' });
                    if(dateEl) dateEl.textContent = now.toLocaleDateString('ar-DZ', { weekday: 'long', day: 'numeric', month: 'long' });
                },
                populateMarquee() {
                    const marqueeContent = document.querySelector('.marquee-content');
                    if (marqueeContent) marqueeContent.innerHTML = App.state.allProducts.map(p => `<span>${p.isOffer ? 'â­' : 'ğŸ•'} ${p.name}</span>`).join('');
                },
            },

            map: {
                init() {
                    if (document.getElementById('map') && !App.state.map) {
                        const defaultCoords = [27.8736, -0.2933];
                        const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' });
                        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' });
                        App.state.map = L.map('map', { layers: [osmLayer] }).setView(defaultCoords, 13);
                        L.control.layers({ "Ø®Ø±ÙŠØ·Ø© Ø¹Ø§Ø¯ÙŠØ©": osmLayer, "ØµÙˆØ± ÙØ¶Ø§Ø¦ÙŠØ©": satelliteLayer }).addTo(App.state.map);
                        App.state.marker = L.marker(defaultCoords, { draggable: true }).addTo(App.state.map);
                        App.state.userLocation = { lat: defaultCoords[0], lng: defaultCoords[1] };
                        App.state.marker.on('dragend', (e) => App.state.userLocation = e.target.getLatLng());
                    }
                }
            },
            
            data: {
                listenForChanges() {
                    onSnapshot(App.services.productsCollectionRef, (snapshot) => {
                        if (snapshot.empty && App.elements.loader.textContent.includes("Ø§Ù„Ø§ØªØµØ§Ù„")) {
                            this.initializeDefault();
                        }
                        App.state.allProducts = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
                        App.render.all();
                        App.elements.loader.classList.add('hidden');
                        App.elements.appContent.classList.remove('hidden');
                    }, (error) => {
                        console.error("Firestore listener error:", error);
                        App.elements.loader.textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…ØªØ¬Ø±.";
                    });
                },
                async initializeDefault() {
                    const defaultProducts = [
                         { id: 'prod_1', name: 'Ø¨ÙŠØªØ²Ø§ Ù…Ø§Ø±ØºØ±ÙŠØªØ§', price: 800, image: 'https://images.unsplash.com/photo-1574071318508-1cdbab80d002?q=80&w=2069&auto=format&fit=crop', category: 'pizza', isAvailable: true, isOffer: true },
                         { id: 'prod_2', name: 'Ø·Ø¨Ù‚ Ù…Ø´Ø§ÙˆÙŠ Ù…Ø´ÙƒÙ„', price: 1800, image: 'https://images.unsplash.com/photo-1628345121123-9383445837e2?q=80&w=1974&auto=format&fit=crop', category: 'grills', isAvailable: true, isOffer: true },
                         { id: 'prod_3', name: 'Ø¹ØµÙŠØ± Ø¨Ø±ØªÙ‚Ø§Ù„ Ø·Ø§Ø²Ø¬', price: 250, image: 'https://images.unsplash.com/photo-1600271886742-f049cd451bba?q=80&w=1887&auto=format&fit=crop', category: 'drinks', isAvailable: true, isOffer: false },
                    ];
                    for (const product of defaultProducts) {
                        try { 
                            const { id: docId, ...productData } = product;
                            await setDoc(doc(App.services.productsCollectionRef, docId), productData);
                        } catch(e) { console.error("Error adding default product:", e); }
                    }
                }
            },
            
            events: {
                setup() {
                    document.body.addEventListener('click', this.handleBodyClick);
                    document.getElementById('login-form').addEventListener('submit', this.handleLogin);
                    document.getElementById('add-product-form').addEventListener('submit', this.handleAddProduct);
                    document.getElementById('admin-panel-section').addEventListener('change', this.handleAdminImageChange);
                    document.getElementById('search-input').addEventListener('input', () => App.render.products());
                },
                async handleBodyClick(e) {
                    const target = e.target;
                    const id = target.dataset.id;
                    if (!target) return;

                    if (target.classList.contains('add-to-cart-btn')) {
                        const product = App.state.allProducts.find(p => p.id === id);
                        if (product && product.isAvailable) { const item = App.state.cart.find(i => i.id === id); if (item) item.quantity++; else App.state.cart.push({ ...product, quantity: 1 }); App.render.cart(); }
                    } else if (target.classList.contains('remove-item-btn')) {
                        App.state.cart = App.state.cart.filter(item => item.id !== id); App.render.cart();
                    } else if (target.closest('.product-image-container')) {
                        document.getElementById('image-modal-src').src = target.closest('.product-image-container').dataset.imgSrc; document.getElementById('image-modal').classList.remove('hidden');
                    } else if (target.id === 'image-modal-close' || target.id === 'image-modal') {
                        document.getElementById('image-modal').classList.add('hidden');
                    } else if (target.id === 'admin-login-btn') {
                        document.getElementById('login-modal').classList.remove('hidden');
                    } else if (target.classList.contains('close-modal-btn')) {
                        document.getElementById('login-modal').classList.add('hidden');
                    } else if (target.id === 'pinpoint-location-btn') {
                        if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(pos => { const { latitude, longitude } = pos.coords; App.state.userLocation = { lat: latitude, lng: longitude }; if(App.state.map){App.state.map.setView([latitude, longitude], 16); App.state.marker.setLatLng([latitude, longitude]);}}, () => alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.'), { enableHighAccuracy: true }); }
                    } else if (target.id === 'whatsapp-btn') {
                        const fName = document.getElementById('firstName').value, lName = document.getElementById('lastName').value; if (!fName || !lName) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù„Ù‚Ø¨.'); return; }
                        const ts = new Date().toLocaleString('ar-DZ', { dateStyle: 'full', timeStyle: 'short' }); let msg = `*Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯* ğŸ›ï¸\n*Ø§Ù„ØªØ§Ø±ÙŠØ®:* ${ts}\n*Ø§Ù„Ø²Ø¨ÙˆÙ†:* ${fName} ${lName}\n\n*Ø§Ù„Ø·Ù„Ø¨Ø§Øª:*\n`; App.state.cart.forEach(i => msg += `- ${i.name} (x${i.quantity}) = ${(i.price * i.quantity).toFixed(2)} Ø¯.Ø¬\n`); msg += `\n*Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${document.getElementById('total-price').textContent} Ø¯.Ø¬*`; if (App.state.userLocation) { msg += `\n\n*Ø§Ù„Ù…ÙˆÙ‚Ø¹:* https://www.google.com/maps?q=${App.state.userLocation.lat},${App.state.userLocation.lng}`; }
                        window.open(`https://wa.me/213775210534?text=${encodeURIComponent(msg)}`, '_blank');
                    } else if (target.closest('#admin-controls')) {
                        if (!id) return;
                        const productRef = doc(App.services.db, `/artifacts/${__app_id || 'default-pizza-app-realtime'}/public/data/products`, id);
                        if (target.classList.contains('delete-btn')) { if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ')) await deleteDoc(productRef); } 
                        else if (target.classList.contains('toggle-status-btn')) { const p = App.state.allProducts.find(p => p.id === id); if(p) await updateDoc(productRef, { isAvailable: !p.isAvailable }); }
                        else if (target.classList.contains('toggle-offer-btn')) { const p = App.state.allProducts.find(p => p.id === id); if(p) await updateDoc(productRef, { isOffer: !p.isOffer }); }
                        else if (target.classList.contains('duplicate-btn')) { const p = App.state.allProducts.find(p => p.id === id); if (p) { const { id: oldId, ...productData } = p; await addDoc(App.services.productsCollectionRef, {...productData, name: `${p.name} (Ù†Ø³Ø®Ø©)`}); } }
                    }
                },
                handleLogin(e) { e.preventDefault(); if (document.getElementById('username').value.trim() === 'azouze' && document.getElementById('password').value.trim() === '19891989') { document.getElementById('login-modal').classList.add('hidden'); document.getElementById('admin-panel-section').classList.remove('hidden'); document.querySelector('footer').classList.add('hidden'); } else { document.getElementById('login-error-msg').textContent = 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø®Ø§Ø·Ø¦Ø©.'; } },
                async handleAddProduct(e) { e.preventDefault(); const newProduct = { name: document.getElementById('new-product-name').value, price: parseFloat(document.getElementById('new-product-price').value), category: document.getElementById('new-product-category').value, image: document.getElementById('new-product-image').value, isAvailable: true, isOffer: false }; if (newProduct.name && newProduct.price > 0) { await addDoc(App.services.productsCollectionRef, newProduct); e.target.reset(); } },
                handleAdminImageChange(e) { if (e.target.classList.contains('edit-image-input')) { const id = e.target.dataset.id; const file = e.target.files[0]; if (!file || !id) return; const reader = new FileReader(); reader.onload = (event) => { const productRef = doc(App.services.db, `/artifacts/${__app_id || 'default-pizza-app-realtime'}/public/data/products`, id); updateDoc(productRef, { image: event.target.result }); }; reader.readAsDataURL(file); } }
            },

            // --- App Entry Point ---
            init() {
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-pizza-app-realtime';

                if (!firebaseConfig.apiKey) {
                    this.elements.loader.textContent = "Ø®Ø·Ø£: Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©!";
                    return;
                }
                
                try {
                    const app = initializeApp(firebaseConfig);
                    this.services.db = getFirestore(app);
                    this.services.auth = getAuth(app);
                    this.services.productsCollectionRef = collection(this.services.db, `/artifacts/${appId}/public/data/products`);
                    
                    this.utils.updateTime(); 
                    setInterval(this.utils.updateTime, 1000);
                    
                    this.events.setup();

                    onAuthStateChanged(this.services.auth, user => {
                        if (user) {
                            this.data.listenForChanges();
                        } else {
                            signInAnonymously(this.services.auth).catch(err => {
                                console.error("Anonymous Sign in failed", err);
                                this.elements.loader.textContent = "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø´Ø¨ÙƒØ©.";
                            });
                        }
                    });
                } catch (e) {
                    console.error("Initialization failed:", e);
                    this.elements.loader.textContent = "ÙØ´Ù„ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.";
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
</body>
</html>
